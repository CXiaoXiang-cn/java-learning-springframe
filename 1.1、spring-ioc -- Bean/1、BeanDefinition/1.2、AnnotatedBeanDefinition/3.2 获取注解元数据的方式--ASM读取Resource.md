
# SimpleMetadataReader

SimpleMetadataReader是基于ASM的ClassReader读取Resource来获取注解元数据。

SimpleMetadataReader内部维护了两个属性：
- 字节码所在的文件Resource。
- 通过ClassReader获取的注解元数据。
```java
private final Resource resource;
private final AnnotationMetadata annotationMetadata;
```
在SimpleMetadataReader的构造函数中，使用ClassReader读取字节码来获取注解元数据。
```java
SimpleMetadataReader(Resource resource, @Nullable ClassLoader classLoader) throws IOException {  
    SimpleAnnotationMetadataReadingVisitor visitor = new SimpleAnnotationMetadataReadingVisitor(classLoader);  
    getClassReader(resource).accept(visitor, PARSING_OPTIONS);  
    this.resource = resource;  
    // 通过字节码获取注解元数据
    this.annotationMetadata = visitor.getMetadata();  
}
```

# CachingMetadataReaderFactory

CachingMetadataReaderFactory是SimpleMetadataReaderFactory的子类。
```java
public class CachingMetadataReaderFactory extends SimpleMetadataReaderFactory
```

下面是最主要的获取MetadataReader的方法getMetadataReader()。
```java
public MetadataReader getMetadataReader(Resource resource) throws IOException {  
   if (this.metadataReaderCache instanceof ConcurrentMap) {  
      // No synchronization necessary...  
      MetadataReader metadataReader = this.metadataReaderCache.get(resource);  
      if (metadataReader == null) {  
         metadataReader = super.getMetadataReader(resource);  
         this.metadataReaderCache.put(resource, metadataReader);  
      }  
      return metadataReader;  
   }  
   else if (this.metadataReaderCache != null) {  
      synchronized (this.metadataReaderCache) {  
         MetadataReader metadataReader = this.metadataReaderCache.get(resource);  
         if (metadataReader == null) {  
            metadataReader = super.getMetadataReader(resource);  
            this.metadataReaderCache.put(resource, metadataReader);  
         }  
         return metadataReader;  
      }  
   }  
   else {  
      return super.getMetadataReader(resource);  
   }  
}
```
